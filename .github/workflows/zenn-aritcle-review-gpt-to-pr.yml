name: Zenn Article Review

on:
  push:
    paths:
      - "articles/*.md"  # Zenn ç”¨ã® md ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‘ã‚¹

permissions:
  contents: read    # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’èª­ã¿å–ã‚‹
  issues: write    # Issue ã®ä½œæˆãƒ»ç·¨é›†ã‚’è¨±å¯

jobs:
  gpt-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: articles/*.md

      - name: Review each markdown file with ChatGPT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BASE_URL="https://api.openai.com/v1/chat/completions"
          HEADERS=(
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $OPENAI_API_KEY"
          )

          ISSUE_TITLE="ðŸ“– Zenn Articles Review Report"
          ISSUE_BODY="## Zenn æŠ€è¡“è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n### æ”¹å–„ç‚¹:\n"

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Reviewing $file..."

            CONTENT=$(cat "$file" | head -c 50000)
            PROMPT="ä»¥ä¸‹ã® Markdown ã§è¨˜è¿°ã•ã‚ŒãŸæŠ€è¡“è¨˜äº‹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ã©ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚Œã°ã„ã„ã‹æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚\n\n\`\`\`markdown\n$CONTENT\n\`\`\`\n\nç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„:\n- èª¤å­—è„±å­—ã‚„æ–‡æ³•ãƒŸã‚¹ã‚’æŒ‡æ‘˜ã™ã‚‹ã“ã¨\n- èª­è€…ãŒåˆå¿ƒè€…ã‹ã‚‰ä¸­ç´šè€…ã§ã‚ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã€å°‚é–€ç”¨èªžã®èª¬æ˜Žã‚’å«ã‚ã‚‹ã“ã¨\n- è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„å›³ã‚„ã‚¤ãƒ©ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ææ¡ˆã‚’ã™ã‚‹ã“ã¨\n- é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿ã—ã€è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨\n- å€‹äººçš„ãªè¦‹è§£ã‚„æ„Ÿæƒ³ã¯ã€å®¢è¦³çš„äº‹å®Ÿã¨ç•°ãªã‚‹ã¨åˆ†ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨"

            PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ã‚ãªãŸã¯æŠ€è¡“è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚"},
                {role: "user", content: $prompt}
              ],
              temperature: 0.5
            }')

            RESPONSE=$(curl -s -X POST "$BASE_URL" "${HEADERS[@]}" -d "$PAYLOAD")

            if [ -z "$RESPONSE" ]; then
              echo "Error: No response from OpenAI API" >&2
              exit 1
            fi

            REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
            ISSUE_BODY+="### ðŸ“„ $file\n$REVIEW_TEXT\n\n---\n"
          done

          echo "$ISSUE_BODY" > issue_body.md

          # Check if an existing issue exists
          EXISTING_ISSUE=$(gh issue list --repo $GITHUB_REPOSITORY --state=open --search "$ISSUE_TITLE" --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Updating existing issue #$EXISTING_ISSUE"
            gh issue edit "$EXISTING_ISSUE" --body "$ISSUE_BODY"
          else
            echo "Creating a new issue"
            gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY"
          fi
