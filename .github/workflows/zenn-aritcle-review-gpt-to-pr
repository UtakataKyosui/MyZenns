name: Zenn Article Review

on:
  pull_request:
    paths:
      - "articles/*.md"  # Zenn ç”¨ã® md ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‘ã‚¹

jobs:
  gpt-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: articles/*.md

      - name: Review each markdown file with ChatGPT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BASE_URL="https://api.openai.com/v1/chat/completions"
          HEADERS=(
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $OPENAI_API_KEY"
          )

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Reviewing $file..."

            CONTENT=$(cat "$file" | head -c 50000)  # æœ€å¤§ 50000 æ–‡å­—ã‚’é€ä¿¡
            PROMPT="ä»¥ä¸‹ã® Markdown ã§è¨˜è¿°ã•ã‚ŒãŸæŠ€è¡“è¨˜äº‹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ã©ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚Œã°ã„ã„ã‹æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚\n\n\`\`\`markdown\n$CONTENT\n\`\`\`\n\nç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„:\n- èª¤å­—è„±å­—ã‚„æ–‡æ³•ãƒŸã‚¹ã‚’æŒ‡æ‘˜ã™ã‚‹ã“ã¨\n- èª­è€…ãŒåˆå¿ƒè€…ã‹ã‚‰ä¸­ç´šè€…ã§ã‚ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã€å°‚é–€ç”¨èªžã®èª¬æ˜Žã‚’å«ã‚ã‚‹ã“ã¨\n- è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„å›³ã‚„ã‚¤ãƒ©ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ææ¡ˆã‚’ã™ã‚‹ã“ã¨\n- é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿ã—ã€è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨\n- å€‹äººçš„ãªè¦‹è§£ã‚„æ„Ÿæƒ³ã¯ã€å®¢è¦³çš„äº‹å®Ÿã¨ç•°ãªã‚‹ã¨åˆ†ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨"

            PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ã‚ãªãŸã¯æŠ€è¡“è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚"},
                {role: "user", content: $prompt}
              ],
              temperature: 0.5
            }')

            RESPONSE=$(curl -s -X POST "$BASE_URL" "${HEADERS[@]}" -d "$PAYLOAD")

            if [ -z "$RESPONSE" ]; then
              echo "Error: No response from OpenAI API" >&2
              exit 1
            fi

            echo "$RESPONSE" | jq -r '.choices[0].message.content' > review_$file.md

            PR_NUMBER=$(echo $GITHUB_REF | awk -F'/' '{print $3}')
            COMMENT_BODY="### Review for $file ðŸ“„\n\n$(cat review_$file.md)"

            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          done

  external_text_suggest:
    needs: gpt-review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: articles/*.md

      - name: Get Writing Advice for each markdown file
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BASE_URL="https://api.openai.com/v1/chat/completions"
          HEADERS=(
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $OPENAI_API_KEY"
          )

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Generating writing advice for $file..."

            CONTENT=$(cat "$file" | head -c 50000)  # æœ€å¤§ 50000 æ–‡å­—ã‚’é€ä¿¡
            PROMPT="ç¾åœ¨åŸ·ç­†ä¸­ã® Markdown ã§è¨˜è¿°ã•ã‚ŒãŸæŠ€è¡“è¨˜äº‹ã®å†…å®¹ã‚’å…ƒã«ã€ä»Šå¾Œã©ã®ã‚ˆã†ãªå†…å®¹ã‚’è¿½åŠ ã™ã¹ãã‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚\n\n\`\`\`markdown\n$CONTENT\n\`\`\`\n\nä»¥ä¸‹ã®ç‚¹ã«é‡ç‚¹ã‚’ç½®ã„ã¦ãã ã•ã„:\n- ç¾åœ¨ã®å†…å®¹ã«ä¸è¶³ã—ã¦ã„ã‚‹è«–ç‚¹\n- èª­è€…ãŒã‚ˆã‚Šç†è§£ã—ã‚„ã™ããªã‚‹èª¬æ˜Žã®è¿½åŠ ææ¡ˆ\n- äº‹ä¾‹ã‚„ãƒ‡ãƒ¼ã‚¿ã®å¼•ç”¨ã®æŽ¨å¥¨\n- å…¨ä½“ã®æ§‹æˆã‚’ã‚ˆã‚Šè«–ç†çš„ã«ã™ã‚‹ãŸã‚ã®æ”¹å–„ç‚¹\n- è¿½åŠ ã™ã¹ãå›³è¡¨ã‚„è¦–è¦šçš„è¦ç´ ã®ææ¡ˆ"

            PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "ã‚ãªãŸã¯æŠ€è¡“è¨˜äº‹ã®åŸ·ç­†ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚"},
                {role: "user", content: $prompt}
              ],
              temperature: 0.5
            }')

            RESPONSE=$(curl -s -X POST "$BASE_URL" "${HEADERS[@]}" -d "$PAYLOAD")

            if [ -z "$RESPONSE" ]; then
              echo "Error: No response from OpenAI API" >&2
              exit 1
            fi

            echo "$RESPONSE" | jq -r '.choices[0].message.content' > advice_$file.md

            PR_NUMBER=$(echo $GITHUB_REF | awk -F'/' '{print $3}')
            COMMENT_BODY="### Writing Advice for $file ðŸ“–\n\n$(cat advice_$file.md)"

            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          done
